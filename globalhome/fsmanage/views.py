# -*- coding:  utf-8-*-

## Create your views here.
#def show_online_calls(request):
#    """возвращает данные об онлайн звонках по ajax-запросу"""
##    import subprocess
##    import sys
##    process = subprocess.Popen('ssh -p 3022 46.61.162.241 "/usr/local/freeswitch/bin/fs_cli -x \'show calls\'"', stdout=subprocess.PIPE, shell=True)
##    sys.stdout.flush()
##    lines = process.stdout.readlines()
#    lines = ['uuid,direction,created,created_epoch,name,state,cid_name,cid_num,ip_addr,dest,presence_id,presence_data,callstate,callee_name,callee_num,callee_direction,call_uuid,hostname,sent_callee_name,sent_callee_num,b_uuid,b_direction,b_created,b_created_epoch,b_name,b_state,b_cid_name,b_cid_num,b_ip_addr,b_dest,b_presence_id,b_presence_data,b_callstate,b_callee_name,b_callee_num,b_callee_direction,b_sent_callee_name,b_sent_callee_num,call_created_epoch\n', 'db6fde4c-2d2e-11e1-af2a-ef927a69f5c2,inbound,2011-12-23 10:25:07,1324621507,sofia/internal/4992711340@195.94.225.2:5060,CS_EXECUTE,4992711340,4992711340,195.94.225.2,4996383000,4992711340@195.94.225.2,,ACTIVE,Outbound Call,74995506639,SEND,db6fde4c-2d2e-11e1-af2a-ef927a69f5c2,debian-vm5,Outbound Call,74995506639,,,,,,,,,,,,,,,,,,,\n', '742e285a-2fd2-11e1-b041-ef927a69f5c2,inbound,2011-12-26 19:01:13,1324911673,sofia/internal/1000061@46.61.162.241,CS_EXECUTE,1000061,1000061,89.107.123.123,84959602760,1000061@46.61.162.241,,ACTIVE,Outbound Call,74959602760,SEND,742e285a-2fd2-11e1-b041-ef927a69f5c2,debian-vm5,Outbound Call,74959602760,,,,,,,,,,,,,,,,,,,\n', '7e2a7bd8-2fd2-11e1-b10f-ef927a69f5c2,inbound,2011-12-26 19:01:30,1324911690,sofia/internal/1000061@46.61.162.241,CS_EXECUTE,1000061,1000061,89.107.123.123,84959602760,1000061@46.61.162.241,,ACTIVE,Outbound Call,74959602760,SEND,7e2a7bd8-2fd2-11e1-b10f-ef927a69f5c2,debian-vm5,Outbound Call,74959602760,,,,,,,,,,,,,,,,,,,\n', '738793f0-3059-11e1-87af-ef927a69f5c2,inbound,2011-12-27 11:07:34,1324969654,sofia/internal/4957003931@195.94.225.2:5060,CS_EXECUTE,4957003931,4957003931,195.94.225.2,4996383000,4957003931@195.94.225.2,,ACTIVE,Outbound Call,74995506639,SEND,738793f0-3059-11e1-87af-ef927a69f5c2,debian-vm5,Outbound Call,74995506639,,,,,,,,,,,,,,,,,,,\n', '0cc2881c-307e-11e1-af05-ef927a69f5c2,inbound,2011-12-27 15:29:33,1324985373,sofia/internal/1000054@sip.globalhome.su,CS_EXECUTE,1000054,1000054,95.171.26.90,84991288313,1000054@sip.globalhome.su,,ACTIVE,Outbound Call,74991288313,SEND,0cc2881c-307e-11e1-af05-ef927a69f5c2,debian-vm5,Outbound Call,74991288313,,,,,,,,,,,,,,,,,,,\n', '030afdaa-316d-11e1-9c45-ef927a69f5c2,inbound,2011-12-28 20:00:07,1325088007,sofia/internal/78124380421@84.52.103.17,CS_HIBERNATE,78124380421,78124380421,84.52.103.17,78124493359,78124380421@84.52.103.17,,ACTIVE,Outbound Call,78124493359,SEND,030afdaa-316d-11e1-9c45-ef927a69f5c2,debian-vm5,Outbound Call,78124493359,030e5928-316d-11e1-9c46-ef927a69f5c2,outbound,2011-12-28 20:00:07,1325088007,sofia/internal/78124493359@46.61.162.242,CS_HIBERNATE,78124380421,78124380421,84.52.103.17,78124493359,,,ACTIVE,Outbound Call,78124493359,SEND,78124380421,78124380421,1325088017\n', '4adf988c-316f-11e1-900b-ef927a69f5c2,inbound,2011-12-28 20:16:26,1325088986,sofia/internal/78124380421@84.52.103.17,CS_HIBERNATE,78124380421,78124380421,84.52.103.17,78124493358,78124380421@84.52.103.17,,ACTIVE,Outbound Call,78124493358,SEND,4adf988c-316f-11e1-900b-ef927a69f5c2,debian-vm5,Outbound Call,78124493358,4ae0d99a-316f-11e1-900c-ef927a69f5c2,outbound,2011-12-28 20:16:26,1325088986,sofia/internal/78124493358@46.61.162.242,CS_HIBERNATE,78124380421,78124380421,84.52.103.17,78124493358,,,ACTIVE,Outbound Call,78124493358,SEND,78124380421,78124380421,1325088996\n', '7f63dbae-316f-11e1-94b3-ef927a69f5c2,inbound,2011-12-28 20:17:54,1325089074,sofia/internal/78124380421@84.52.103.17,CS_HIBERNATE,78124380421,78124380421,84.52.103.17,78124493360,78124380421@84.52.103.17,,ACTIVE,Outbound Call,78124493360,SEND,7f63dbae-316f-11e1-94b3-ef927a69f5c2,debian-vm5,Outbound Call,78124493360,7f65653c-316f-11e1-94b4-ef927a69f5c2,outbound,2011-12-28 20:17:54,1325089074,sofia/internal/78124493360@46.61.162.242,CS_HIBERNATE,78124380421,78124380421,84.52.103.17,78124493360,,,ACTIVE,Outbound Call,78124493360,SEND,78124380421,78124380421,1325089084\n', 'a227b82c-316f-11e1-97b8-ef927a69f5c2,inbound,2011-12-28 20:18:52,1325089132,sofia/internal/78127025661@84.52.103.17,CS_HIBERNATE,78127025661,78127025661,84.52.103.17,78124493359,78127025661@84.52.103.17,,ACTIVE,Outbound Call,78124493359,SEND,a227b82c-316f-11e1-97b8-ef927a69f5c2,debian-vm5,Outbound Call,78124493359,a228dcb6-316f-11e1-97b9-ef927a69f5c2,outbound,2011-12-28 20:18:52,1325089132,sofia/internal/78124493359@46.61.162.242,CS_HIBERNATE,78127025661,78127025661,84.52.103.17,78124493359,,,ACTIVE,Outbound Call,78124493359,SEND,78127025661,78127025661,1325089143\n', '67f51126-3170-11e1-a934-ef927a69f5c2,inbound,2011-12-28 20:24:24,1325089464,sofia/internal/78127025661@84.52.103.17,CS_HIBERNATE,78127025661,78127025661,84.52.103.17,78124493358,78127025661@84.52.103.17,,ACTIVE,Outbound Call,78124493358,SEND,67f51126-3170-11e1-a934-ef927a69f5c2,debian-vm5,Outbound Call,78124493358,67f5cb2a-3170-11e1-a935-ef927a69f5c2,outbound,2011-12-28 20:24:24,1325089464,sofia/internal/78124493358@46.61.162.242,CS_HIBERNATE,78127025661,78127025661,84.52.103.17,78124493358,,,ACTIVE,Outbound Call,78124493358,SEND,78127025661,78127025661,1325089474\n', 'c89a6f26-3170-11e1-b1d6-ef927a69f5c2,inbound,2011-12-28 20:27:06,1325089626,sofia/internal/8124583512@195.94.225.2:5060,CS_EXECUTE,8124583512,8124583512,195.94.225.2,4996383207,8124583512@195.94.225.2,,ACTIVE,Outbound Call,74996383207,SEND,c89a6f26-3170-11e1-b1d6-ef927a69f5c2,debian-vm5,Outbound Call,74996383207,c89bff58-3170-11e1-b1d7-ef927a69f5c2,outbound,2011-12-28 20:27:06,1325089626,sofia/internal/74996383207@46.61.162.242,CS_EXCHANGE_MEDIA,8124583512,8124583512,195.94.225.2,74996383207,,,ACTIVE,Outbound Call,74996383207,SEND,8124583512,8124583512,1325089637\n', '2a8cfcc6-3171-11e1-ba8e-ef927a69f5c2,inbound,2011-12-28 20:29:51,1325089791,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380804,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380804,SEND,2a8cfcc6-3171-11e1-ba8e-ef927a69f5c2,debian-vm5,Outbound Call,78123380804,2a8f6650-3171-11e1-ba8f-ef927a69f5c2,outbound,2011-12-28 20:29:51,1325089791,sofia/internal/78123380804@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380804,,,ACTIVE,Outbound Call,78123380804,SEND,78122404438,78122404438,1325089801\n', '2aab9f50-3171-11e1-ba93-ef927a69f5c2,inbound,2011-12-28 20:29:51,1325089791,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380571,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380571,SEND,2aab9f50-3171-11e1-ba93-ef927a69f5c2,debian-vm5,Outbound Call,78123380571,2aad1eca-3171-11e1-ba94-ef927a69f5c2,outbound,2011-12-28 20:29:51,1325089791,sofia/internal/78123380571@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380571,,,ACTIVE,Outbound Call,78123380571,SEND,78122404438,78122404438,1325089801\n', '2ab121aa-3171-11e1-ba95-ef927a69f5c2,inbound,2011-12-28 20:29:51,1325089791,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380633,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380633,SEND,2ab121aa-3171-11e1-ba95-ef927a69f5c2,debian-vm5,Outbound Call,78123380633,2ab29648-3171-11e1-ba96-ef927a69f5c2,outbound,2011-12-28 20:29:51,1325089791,sofia/internal/78123380633@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380633,,,ACTIVE,Outbound Call,78123380633,SEND,78122404438,78122404438,1325089801\n', '2ab8327e-3171-11e1-ba97-ef927a69f5c2,inbound,2011-12-28 20:29:51,1325089791,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380035,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380035,SEND,2ab8327e-3171-11e1-ba97-ef927a69f5c2,debian-vm5,Outbound Call,78123380035,2ab915e0-3171-11e1-ba98-ef927a69f5c2,outbound,2011-12-28 20:29:51,1325089791,sofia/internal/78123380035@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380035,,,ACTIVE,Outbound Call,78123380035,SEND,78122404438,78122404438,1325089801\n', '2b153668-3171-11e1-ba9c-ef927a69f5c2,inbound,2011-12-28 20:29:52,1325089792,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380715,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380715,SEND,2b153668-3171-11e1-ba9c-ef927a69f5c2,debian-vm5,Outbound Call,78123380715,2b191cc4-3171-11e1-ba9d-ef927a69f5c2,outbound,2011-12-28 20:29:52,1325089792,sofia/internal/78123380715@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380715,,,ACTIVE,Outbound Call,78123380715,SEND,78122404438,78122404438,1325089802\n', '2b1a2948-3171-11e1-ba9e-ef927a69f5c2,inbound,2011-12-28 20:29:52,1325089792,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380627,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380627,SEND,2b1a2948-3171-11e1-ba9e-ef927a69f5c2,debian-vm5,Outbound Call,78123380627,2b1aef86-3171-11e1-ba9f-ef927a69f5c2,outbound,2011-12-28 20:29:52,1325089792,sofia/internal/78123380627@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380627,,,ACTIVE,Outbound Call,78123380627,SEND,78122404438,78122404438,1325089802\n', 'ad9152ac-3171-11e1-863c-ef927a69f5c2,inbound,2011-12-28 20:33:31,1325090011,sofia/internal/1000015@sip.globalhome.su,CS_EXECUTE,1000015,1000015,83.242.203.53,89052613947,1000015@sip.globalhome.su,,ACTIVE,Outbound Call,79052613947,SEND,ad9152ac-3171-11e1-863c-ef927a69f5c2,debian-vm5,Outbound Call,79052613947,adace8be-3171-11e1-863f-ef927a69f5c2,outbound,2011-12-28 20:33:31,1325090011,h323/79052613947@46.61.162.247,CS_EXCHANGE_MEDIA,1000015,74956600875,83.242.203.53,79052613947@46.61.162.247,,,ACTIVE,Outbound Call,79052613947,,,,1325090018\n', '13316854-3172-11e1-8f36-ef927a69f5c2,inbound,2011-12-28 20:36:21,1325090181,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380105,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380105,SEND,13316854-3172-11e1-8f36-ef927a69f5c2,debian-vm5,Outbound Call,78123380105,13369234-3172-11e1-8f37-ef927a69f5c2,outbound,2011-12-28 20:36:21,1325090181,sofia/internal/78123380105@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380105,,,ACTIVE,Outbound Call,78123380105,SEND,78122404438,78122404438,1325090191\n', '133731f8-3172-11e1-8f38-ef927a69f5c2,inbound,2011-12-28 20:36:21,1325090181,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380853,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380853,SEND,133731f8-3172-11e1-8f38-ef927a69f5c2,debian-vm5,Outbound Call,78123380853,133af838-3172-11e1-8f39-ef927a69f5c2,outbound,2011-12-28 20:36:21,1325090181,sofia/internal/78123380853@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380853,,,ACTIVE,Outbound Call,78123380853,SEND,78122404438,78122404438,1325090191\n', '13516bea-3172-11e1-8f3a-ef927a69f5c2,inbound,2011-12-28 20:36:21,1325090181,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380697,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380697,SEND,13516bea-3172-11e1-8f3a-ef927a69f5c2,debian-vm5,Outbound Call,78123380697,135317e2-3172-11e1-8f3b-ef927a69f5c2,outbound,2011-12-28 20:36:21,1325090181,sofia/internal/78123380697@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380697,,,ACTIVE,Outbound Call,78123380697,SEND,78122404438,78122404438,1325090191\n', '71455e28-3172-11e1-979b-ef927a69f5c2,inbound,2011-12-28 20:38:59,1325090339,sofia/internal/1000080@46.61.162.241,CS_EXECUTE,1000080,1000080,195.91.137.75,89611087163,1000080@46.61.162.241,,ACTIVE,Outbound Call,79611087163,SEND,71455e28-3172-11e1-979b-ef927a69f5c2,debian-vm5,Outbound Call,79611087163,716435b4-3172-11e1-979f-ef927a69f5c2,outbound,2011-12-28 20:38:59,1325090339,h323/79611087163@46.61.162.247,CS_EXCHANGE_MEDIA,1000080,74956605613,195.91.137.75,79611087163@46.61.162.247,,,ACTIVE,Outbound Call,79611087163,,,,1325090346\n', 'fbd83998-3172-11e1-a3f8-ef927a69f5c2,inbound,2011-12-28 20:42:51,1325090571,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380544,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380544,SEND,fbd83998-3172-11e1-a3f8-ef927a69f5c2,debian-vm5,Outbound Call,78123380544,fbda5f0c-3172-11e1-a3fa-ef927a69f5c2,outbound,2011-12-28 20:42:51,1325090571,sofia/internal/78123380544@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380544,,,ACTIVE,Outbound Call,78123380544,SEND,78122404438,78122404438,1325090582\n', 'fbda1178-3172-11e1-a3f9-ef927a69f5c2,inbound,2011-12-28 20:42:51,1325090571,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380454,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380454,SEND,fbda1178-3172-11e1-a3f9-ef927a69f5c2,debian-vm5,Outbound Call,78123380454,fbddcfe8-3172-11e1-a3fb-ef927a69f5c2,outbound,2011-12-28 20:42:51,1325090571,sofia/internal/78123380454@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380454,,,ACTIVE,Outbound Call,78123380454,SEND,78122404438,78122404438,1325090582\n', 'fd8e1b4a-3172-11e1-a42b-ef927a69f5c2,inbound,2011-12-28 20:42:54,1325090574,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380809,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380809,SEND,fd8e1b4a-3172-11e1-a42b-ef927a69f5c2,debian-vm5,Outbound Call,78123380809,fd95b198-3172-11e1-a42c-ef927a69f5c2,outbound,2011-12-28 20:42:54,1325090574,sofia/internal/78123380809@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380809,,,ACTIVE,Outbound Call,78123380809,SEND,78122404438,78122404438,1325090584\n', 'e3876106-3173-11e1-b87e-ef927a69f5c2,inbound,2011-12-28 20:49:20,1325090960,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380940,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380940,SEND,e3876106-3173-11e1-b87e-ef927a69f5c2,debian-vm5,Outbound Call,78123380940,e388b948-3173-11e1-b880-ef927a69f5c2,outbound,2011-12-28 20:49:20,1325090960,sofia/internal/78123380940@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380940,,,ACTIVE,Outbound Call,78123380940,SEND,78122404438,78122404438,1325090970\n', 'e3a3128e-3173-11e1-b885-ef927a69f5c2,inbound,2011-12-28 20:49:20,1325090960,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380518,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380518,SEND,e3a3128e-3173-11e1-b885-ef927a69f5c2,debian-vm5,Outbound Call,78123380518,e3a50670-3173-11e1-b886-ef927a69f5c2,outbound,2011-12-28 20:49:20,1325090960,sofia/internal/78123380518@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380518,,,ACTIVE,Outbound Call,78123380518,SEND,78122404438,78122404438,1325090970\n', 'eae8b27e-3173-11e1-b90d-ef927a69f5c2,inbound,2011-12-28 20:49:32,1325090972,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380680,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380680,SEND,eae8b27e-3173-11e1-b90d-ef927a69f5c2,debian-vm5,Outbound Call,78123380680,eae96214-3173-11e1-b90e-ef927a69f5c2,outbound,2011-12-28 20:49:32,1325090972,sofia/internal/78123380680@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380680,,,ACTIVE,Outbound Call,78123380680,SEND,78122404438,78122404438,1325090983\n', 'eae9bf02-3173-11e1-b90f-ef927a69f5c2,inbound,2011-12-28 20:49:33,1325090973,sofia/internal/78122404438@84.52.103.17,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380075,78122404438@84.52.103.17,,ACTIVE,Outbound Call,78123380075,SEND,eae9bf02-3173-11e1-b90f-ef927a69f5c2,debian-vm5,Outbound Call,78123380075,eaea771c-3173-11e1-b910-ef927a69f5c2,outbound,2011-12-28 20:49:33,1325090973,sofia/internal/78123380075@46.61.162.242,CS_HIBERNATE,78122404438,78122404438,84.52.103.17,78123380075,,,ACTIVE,Outbound Call,78123380075,SEND,78122404438,78122404438,1325090983\n', '\n', '29 total.\n', '\n']
#    for i, l in enumerate(lines):
#        print i, l
#    calls = lines[1:] if len(lines) > 0 else []
#    return render_to_response('online_calls_table.html', {'oc': calls})

from django import http
from django.views.generic import simple

def show_online_calls(request):
#    if not authutil.is_root_or_admin(request):
#        msg = "You are not currently logged in w/ enough permissions"
#        return http.HttpResponseRedirect("/?urgentmsg=%s" % msg)
#    account = request.user.get_profile().account
    from lib import fsutil
    channels = []
    for connection in fsutil.get_fs_connections():
        try:
            results = connection.sendRecv("api show channels")
            if not results:
                raise Exception("Could not connect to FreeSWITCH")
            data = results.getBody().splitlines()

            if len(data) > 3:
                headers = data[0].split(',')
                header_strings = (
                    'name', 'dest', 'cid_num', 'cid_name', 'created', 'uuid')
                indexes = map(headers.index, header_strings)
                assert all(x != -1 for x in indexes), \
                       "Unable to parse Freeswitch response"
                for i in range(1, len(data) - 2):
                    values = data[i].split(',')
                    channels.append(dict(
                        (header_strings[j], values[indexes[j]])
                        for j in range(len(header_strings))))

        except Exception, e:
            msg = "Could not get live calls: %s" % str(e)
            url = "/dashboard/?urgentmsg=%s" % msg
            return http.HttpResponseRedirect(url)

        else:
            return simple.direct_to_template(
                request, 'livecalls.html', {'channels':channels})
